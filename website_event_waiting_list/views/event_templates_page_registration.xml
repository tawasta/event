<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="registration_template_waiting_list" inherit_id="website_event.registration_template">
        <!-- Replace event registration to add waiting list -->

        <!-- Multi ticket view -->
        <xpath expr="//div[@class='w-auto ml-auto']" position="replace">
            <t t-if="event.waiting_list">
                <select t-if="not ticket.is_expired and ticket.sale_available and event.seats_available > 0"
                        t-attf-name="nb_register-#{ticket.id}"
                        class="custom-select">
                    <t t-set="seats_max_ticket" t-value="(not ticket.seats_limited or ticket.seats_available &gt; 9) and 10 or ticket.seats_available + 1"/>
                    <t t-set="seats_max_event" t-value="(not event.seats_limited or event.seats_available &gt; 9) and 10 or event.seats_available + 1"/>
                    <t t-set="seats_max" t-value="min(seats_max_ticket, seats_max_event)"/>
                    <t t-foreach="range(0, seats_max)" t-as="nb">
                        <option t-esc="nb" t-att-selected="len(ticket) == 0 and nb == 0 and 'selected'"/>
                    </t>
                </select>
                <div t-else="" class="text-danger">
                    <span t-if="not ticket.sale_available and not ticket.is_expired and ticket.is_launched() or event.seats_available &lt;= 0">Sold Out</span>
                    <select t-if="not ticket.sale_available and not ticket.is_expired and ticket.is_launched() or event.seats_available &lt;= 0"
                            t-attf-name="nb_register-#{ticket.id}"
                            class="custom-select">
                        <t t-foreach="range(0, 10)" t-as="nb">
                            <option t-esc="nb" t-att-selected="len(ticket) == 0 and nb == 0 and 'selected'"/>
                        </t>
                    </select>
                    <span t-if="ticket.is_expired">Expired</span>
                </div>
            </t>
            <t t-else="">
                <div class="w-auto ml-auto">
                    <select t-if="not ticket.is_expired and ticket.sale_available"
                            t-attf-name="nb_register-#{ticket.id}"
                            class="custom-select">
                        <t t-set="seats_max_ticket" t-value="(not ticket.seats_limited or ticket.seats_available &gt; 9) and 10 or ticket.seats_available + 1"/>
                        <t t-set="seats_max_event" t-value="(not event.seats_limited or event.seats_available &gt; 9) and 10 or event.seats_available + 1"/>
                        <t t-set="seats_max" t-value="min(seats_max_ticket, seats_max_event)"/>
                        <t t-foreach="range(0, seats_max)" t-as="nb">
                            <option t-esc="nb" t-att-selected="len(ticket) == 0 and nb == 0 and 'selected'"/>
                        </t>
                    </select>
                    <div t-else="" class="text-danger">
                        <span t-if="not ticket.sale_available and not ticket.is_expired and ticket.is_launched()" >Sold Out</span>
                        <span t-if="ticket.is_expired">Expired</span>
                    </div>
                </div>
            </t>
        </xpath>
        <!-- Replace multi ticket view submit button -->
        <xpath expr="//div[@class='col-md-4 offset-md-8 py-2 pl-md-0 pr-md-2']" position="replace">
            <div class="col-md-4 offset-md-8 py-2 pl-md-0 pr-md-2">
                <t t-if="any(event.waiting_list and not ticket.sale_available and not ticket.is_expired and ticket.is_launched() or event.waiting_list and event.seats_available &lt;= 0 for ticket in tickets)">
                    <button type="submit" name="waiting_list_button" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                        Join the waiting list
                    </button>
                </t>
                <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt; 1">
                    <button class="btn btn-danger btn-block" disabled="1">
                        Sold Out
                    </button>
                </t>
                <t t-else="">
                    <button type="submit" name="register_button" class="btn btn-primary o_wait_lazy_js btn-block a-submit" disabled="" t-attf-id="#{event.id}">
                        Register
                        <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt;= (event.seats_max * 0.2)">
                            (only <t t-esc="event.seats_available"/> available)
                        </t>
                    </button>
                </t>
            </div>
        </xpath>

        <!-- Single ticket view -->
        <xpath expr="//t[@t-if='event.event_registrations_open']" position="replace">
            <t t-if="event.event_registrations_open">
                <t t-if="tickets">
                    <t t-if="not tickets.sale_available and not tickets.is_expired and event.waiting_list or event.waiting_list and event.seats_available &lt;= 0">
                        <span itemprop="availability" content="http://schema.org/SoldOut" class="text-danger">
                            <i class="fa fa-ban mr-2"/>Sold Out
                        </span>
                        <select t-att-name="'nb_register-%s' % (tickets.id if tickets else 0)" class="w-auto custom-select">
                            <t t-foreach="range(0, 10)" t-as="nb">
                                <option t-esc="nb" t-att-selected="nb == 1 and 'selected'"/>
                            </t>
                        </select>
                    </t>
                    <t t-else="">
                        <span class="text-dark font-weight-bold align-middle pr-2">Qty</span>
                        <link itemprop="availability" content="http://schema.org/InStock"/>
                        <select t-att-name="'nb_register-%s' % (tickets.id if tickets else 0)" class="w-auto custom-select">
                            <t t-set="seats_max_ticket" t-value="(not tickets or not tickets.seats_limited or tickets.seats_available &gt; 9) and 10 or tickets.seats_available + 1"/>
                            <t t-set="seats_max_event" t-value="(not event.seats_limited or event.seats_available &gt; 9) and 10 or event.seats_available + 1"/>
                            <t t-set="seats_max" t-value="min(seats_max_ticket, seats_max_event) if tickets else seats_max_event"/>
                            <t t-foreach="range(0, seats_max)" t-as="nb">
                                <option t-esc="nb" t-att-selected="nb == 1 and 'selected'"/>
                            </t>
                        </select>
                    </t>
                </t>
                <t t-else="">
                    <t t-if="event.event_registrations_sold_out and event.waiting_list">
                        <span itemprop="availability" content="http://schema.org/SoldOut" class="text-danger">
                            <i class="fa fa-ban mr-2"/>Sold Out
                        </span>
                        <select t-att-name="'nb_register-%s' % (tickets.id if tickets else 0)" class="w-auto custom-select">
                            <t t-foreach="range(0, 10)" t-as="nb">
                                <option t-esc="nb" t-att-selected="nb == 1 and 'selected'"/>
                            </t>
                        </select>
                    </t>
                    <t t-else="">
                        <span class="text-dark font-weight-bold align-middle pr-2">Qty</span>
                        <link itemprop="availability" content="http://schema.org/InStock"/>
                        <select t-att-name="'nb_register-%s' % (tickets.id if tickets else 0)" class="w-auto custom-select">
                            <t t-set="seats_max_ticket" t-value="(not tickets or not tickets.seats_limited or tickets.seats_available &gt; 9) and 10 or tickets.seats_available + 1"/>
                            <t t-set="seats_max_event" t-value="(not event.seats_limited or event.seats_available &gt; 9) and 10 or event.seats_available + 1"/>
                            <t t-set="seats_max" t-value="min(seats_max_ticket, seats_max_event) if tickets else seats_max_event"/>
                            <t t-foreach="range(0, seats_max)" t-as="nb">
                                <option t-esc="nb" t-att-selected="nb == 1 and 'selected'"/>
                            </t>
                        </select>
                    </t>
                </t>
            </t>
        </xpath>
        <!-- Single ticket view submit button -->
        <xpath expr="//div[@class='col-lg-4 pt-3 pt-lg-0 pl-2 pl-lg-0']" position="replace">
            <div class="col-lg-4 pt-3 pt-lg-0 pl-2 pl-lg-0">
                <t t-if="event.waiting_list and event.event_registrations_open and event.seats_available &lt;=0">
                    <button type="submit" name="waiting_list_button" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                        Join the waiting list
                    </button>
                </t>
                <t t-else="">
                    <button type="submit" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                        Register
                        <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt;= (event.seats_max * 0.2)">
                            (only <t t-esc="event.seats_available"/> available)
                        </t>
                    </button>
                </t>
            </div>
        </xpath>
    </template>

    <!-- Modal to register for an event inherit to add waiting list -->
    <template id="registration_attendee_details" inherit_id="website_event.registration_attendee_details">
        <xpath expr="//h4[@class='modal-title']" position="replace">
            <t t-if="waiting_list_check">
                <h4 class="modal-title">Attendees for waiting list</h4>
            </t>
            <t t-else="">
                <h4 class="modal-title">Attendees</h4>
            </t>
        </xpath>
        <xpath expr="//t[@t-foreach='tickets']" position="attributes">
            <attribute name="t-if">availability_check or waiting_list_check</attribute>
        </xpath>
        <xpath expr="//t[@t-if='not availability_check']" position="replace">
            <t t-if="not availability_check or not waiting_list_check">
                <div class="modal-body bg-light border-bottom">
                    <strong><t t-esc="warning_msg"/></strong>
                </div>
            </t>
        </xpath>
        <xpath expr="//button[@type='submit']" position="replace">
            <input class="d-none" type="text" t-attf-name="waiting_list_check" t-attf-value="#{waiting_list_check}"/>
            <button type="submit" class="btn btn-primary" t-if="availability_check or waiting_list_check">Continue</button>
        </xpath>
    </template>

    <!-- Confirmation page add waiting list -->
    <template id="registration_complete" inherit_id="website_event.registration_complete">
        <xpath expr="//div[@class='col-12']" position="replace">
            <div class="col-12">
                <t t-if="attendees[0].state == 'wait'">
                    <h3>Joined waiting list!</h3>
                </t>
                <t t-else="">
                    <h3>Registration confirmed!</h3>
                </t>
                <span class="h4 text-muted" t-esc="event.name"/>
                <t t-if="attendees[0].state == 'wait'">
                    <p class="py-2">You will be contacted if the event has more seats available.</p>
                </t>
            </div>
        </xpath>
    </template>

    <!-- Redirect if registration fails -->
    <template id="registration_fail" name="Registration Fail">
        <t t-call="website_event.layout">
            <div class="container my-5 o_wereg_confirmed">
                <div class="row mb-3">
                    <div class="col-12">
                        <h3>Registration failed!</h3>
                        <span class="h4 text-muted" t-esc="event.name"/>
                        <p class="py-2"><t t-esc="warning_msg"/></p>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
