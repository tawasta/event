<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="registration_template_waiting_list" inherit_id="website_event.registration_template">
    <!--     <xpath expr="//select[@t-if='not ticket.is_expired and ticket.sale_available']" position="attributes"> -->
    <!--         <attribute name="t-if">not ticket.is_expired and ticket.sale_available and ticket.seats_available</attribute> -->
    <!--     </xpath> -->


        <xpath expr="//t[@t-if='event.event_registrations_open']" position="attributes">
            <attribute name="t-if">event.event_registrations_open and tickets.seats_available</attribute>
        </xpath>

        <xpath expr="//select[@t-if='not ticket.is_expired and ticket.sale_available']" position="after">
            <span itemprop="availability" content="http://schema.org/SoldOut" class="text-danger">
                <i class="fa fa-ban mr-2"/>Sold Out
            </span>
            <select t-if="not ticket.is_expired and not ticket.sale_available and ticket.waiting_list"
                    t-attf-name="nb_register-#{ticket.id}"
                    class="custom-select">
                <t t-foreach="range(0, 10)" t-as="nb">
                    <option t-esc="nb" t-att-selected="len(ticket) == 0 and nb == 0 and 'selected'"/>
                </t>
            </select>
        </xpath>

        <xpath expr="//div[@class='col-md-4 offset-md-8 py-2 pl-md-0 pr-md-2']" position ="replace">
            <div class="col-md-4 offset-md-8 py-2 pl-md-0 pr-md-2">
                <t t-if="event.waiting_list and event.event_registrations_open and event.seats_available &lt;=0">
                    <button type="submit" name="waiting_list" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                        Join the waiting list
                    </button>
                </t>
                <t t-else="">
                    <button type="submit" class="btn btn-primary o_wait_lazy_js btn-block a-submit" disabled="" t-attf-id="#{event.id}">
                        Register
                        <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt;= (event.seats_max * 0.2) and event.seats_available &gt; 0">
                            (only <t t-esc="event.seats_available"/> available)
                        </t>
                    </button>
                </t>
            </div>
        </xpath>

        <xpath expr="//div[@class='col-lg-4 pt-3 pt-lg-0 pl-2 pl-lg-0']" position="replace">
            <div class="col-lg-4 pt-3 pt-lg-0 pl-2 pl-lg-0">
                <t t-if="event.waiting_list and event.event_registrations_open and event.seats_available &lt;=0">
                    <button type="submit" name="waiting_list" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                        Join the waiting list
                    </button>
                    <t t-call="website_event_waiting_list.waiting_list_attendee_details"/>
                </t>
                <t t-else="">
                    <button type="submit" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                        Register
                        <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt;= (event.seats_max * 0.2)">
                            (only <t t-esc="event.seats_available"/> available)
                        </t>
                    </button>
                </t>
            </div>
        </xpath>
    </template>

    <!-- Modal to join waiting list -->
    <template id="waiting_list_attendee_details" name="Waiting List Attendee Details">
        <div id="modal_attendees_waiting" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <form id="attendee_waiting" t-attf-action="/event/#{slug(event)}/registration/confirm" method="post" class="js_website_submit_form">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <div class="modal-content">
                        <div class="modal-header align-items-center">
                            <h4 class="modal-title">Attendees for waiting list</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>Ã—</span></button>
                        </div>
                        <t t-set="counter_type" t-value="1"/>
                        <t t-set="counter" t-value="0"/>
                        <t t-foreach="tickets" t-as="ticket">
                            <t t-foreach="range(1, ticket['quantity'] + 1)" t-as="att_counter" name="attendee_loop">
                                <t t-set="counter" t-value="counter + 1"/>
                                <div class="modal-body bg-light border-bottom">
                                    <h5 class="mt-1 pb-2 border-bottom">Ticket #<span t-esc="counter"/> <small class="text-muted">- <span t-esc="ticket['name']"/></small></h5>
                                    <div class="row">
                                        <div class="col-lg my-2">
                                            <label>Name</label>
                                            <input class="form-control" type="text" t-attf-name="#{counter}-name" required="This field is required"/>
                                        </div>
                                        <div class="col-lg my-2">
                                            <label>Email</label>
                                            <input class="form-control" type="email" t-attf-name="#{counter}-email" required="This field is required"/>
                                        </div>
                                        <div class="col-lg my-2">
                                            <label>Phone <small>(Optional)</small></label>
                                            <input class="form-control" type="tel" t-attf-name="#{counter}-phone"/>
                                        </div>
                                        <input class="d-none" type="text" t-attf-name="#{counter}-event_ticket_id" t-attf-value="#{ticket['id']}"/>
                                    </div>
                                </div>
                            </t>
                            <t t-set="counter_type" t-value="counter_type + 1"/>
                        </t>
                        <div class="modal-footer border-0 justify-content-between">
                            <button type="button" class="btn btn-secondary js_goto_event" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" t-if="waiting_list_check">Continue</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </template>
</odoo>
