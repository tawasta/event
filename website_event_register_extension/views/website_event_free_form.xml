<?xml version="1.0" encoding="UTF-8"?>
<openerp>
	<data>

		<!-- Checkout form for free events-->
		<template id="event_free_form" name="Free event registration">
			<t t-call="website.layout">
                <div id="wrap">
                <form action="/shop/confirm_order" method="post" class="container">
                    <h3 class="page-header mt32">Your Details</h3>
                    <div class="row">
                        <div id="name_div" t-attf-class="form-group col-lg-6 #{error.get('name') and 'has-error' or ''}">
                            <label class="control-label" for="name">Your Name / Company name</label>
                            <input type="text" name="name" class="form-control" t-att-value="checkout.get('name')" required="required" />
                        </div>
                        <div div="email_div" t-attf-class="form-group col-lg-6 #{error.get('email') and 'has-error' or ''}">
                            <label class="control-label" for="email">Email</label>
                            <input type="email" name="email" class="form-control" t-att-value="checkout.get('email')" required="required" />
                        </div>
                    </div> 
                    <div class="row">
                        <div id="phone_div" t-attf-class="form-group col-lg-6 #{error.get('phone') and 'has-error' or ''}">
                            <label class="control-label" for="phone">Phone</label>
                            <input type="tel" name="phone" class="form-control" t-att-value="checkout.get('phone')" />
                        </div>
                    </div>

                    <!-- Form is validated using website_sale.checkout parse methods that require shipping_id -->
                    <div class="form-group col-lg-12 hidden">
                    	<label>Shipping</label>
                    	<select name="shipping_id" class="form-control">
                    		<option value="0">Ship to the same address</option>
                    	</select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg pull-right">Register <span class="fa fa-long-arrow-right"/></button>
                </form>
                </div>
            </t>
		</template>

        <!-- Modify event_description_full to handle free events (max tickets available comes from event, not from ticket type)-->
        <template id="event_description_full" inherit_id="website_event_sale.event_description_full" customize_show="True" name="Event's Ticket form">
            <xpath expr="//select[@t-if='ticket.seats_available or not ticket.seats_max']" position="replace">
                <select t-if="(ticket.seats_available or not ticket.seats_max) and event.seats_available" t-attf-name="ticket-#{ ticket.id }" class="form-control">
                    <t t-foreach="range(0, min(ticket.seats_available + 1, min((event.seats_available or 9) + 1, 10)))" t-as="nb">
                        <option t-esc="nb"/>
                    </t>
                </select>
            </xpath>
            
            <xpath expr="//span[@t-if='not ticket.seats_available and ticket.seats_max']" position="replace">
                <span t-if="not ticket.seats_available and ticket.seats_max or not event.seats_available">
                    Sold Out
                </span>
            </xpath>

            <!-- If all the tickets are expired or the event has passed, hide the table head -->
            <xpath expr="//form/table[@itemprop='offers']/thead/tr" position="replace">
                <t t-set="headPresent" t-value="False"/>
                <t t-foreach="event.event_ticket_ids" t-as="ticket">
                    <t t-if="not ticket.is_expired">
                        <t t-set="headPresent" t-value="True"/>
                    </t>
                </t>
                <t t-if="(event.seats_available or not event.seats_max) and (today &lt; event.date_end) and headPresent">
                    <tr>
                        <th>Ticket Type</th>
                        <th style="min-width: 100px">Sales End</th>
                        <th style="min-width: 100px">Price</th>
                        <th></th>
                        <th>Quantity</th>
                    </tr>
                </t>
            </xpath>


            <!-- If deadline is passed, remove order now button -->
            <xpath expr="//form/button[@t-if='event.seats_available or not event.seats_max']" position="replace">
                <t t-set="ticketPresent" t-value="False"/>
                <t t-foreach="event.event_ticket_ids" t-as="ticket">
                    <t t-if="not ticket.is_expired">
                        <t t-set="ticketPresent" t-value="True"/>
                    </t>
                </t>
                
                <t t-set="today" t-value="time.strftime('%%Y-%%m-%%d')" />
                <button type="submit" class="btn btn-primary btn-lg pull-right" t-if="(event.seats_available or not event.seats_max) and (today &lt; event.date_end) and ticketPresent">Order Now</button> 
            </xpath>

            <!-- If deadline or event_end are passed, remove row -->
            <xpath expr="//tr[@itemtype='http://data-vocabulary.org/Offer']" position="attributes">
                <attribute name="t-if">not ticket.is_expired and (time.strftime('%%Y-%%m-%%d') &lt; event.date_end)</attribute>        
            </xpath>
        </template>

        <!-- Show tickets availability instead of events -->
        <template id="index" inherit_id="website_event_sale.index" name="Event's Ticket">
            <xpath expr="//li[@t-foreach='event_ids']/div/t[1]" position="replace">
                <t t-if="event.state in ['draft', 'confirm'] and event.event_ticket_ids">
                    <div class="pull-right" style="width:210px;">
                        <ul class="media-list">
                            <li t-foreach="event.event_ticket_ids" t-as="ticket" class="media mt4">
                                <span t-if="not ticket.seats_available and event.seats_max" class="label pull-left label-danger">
                                    <t t-esc="ticket.name"/>: Sold Out
                                </span>
                                <span t-if="ticket.seats_available and ticket.seats_available &lt;= ((ticket.seats_max or 0) / 4)" class="label pull-left label-info">
                                    <t t-esc="ticket.name"/>: Only <t t-esc="ticket.seats_available"/> Remaining
                                </span>
                            </li>
                        </ul>
                    </div>
                </t>
            </xpath>
        </template>

	</data>
</openerp>