<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Overwrites the agenda layout -->
    <template id="website_event_track.agenda">
        <t t-call="website_event.layout">

            <section class="container">
                <h1 class="text-center" t-field="event.name"/>
                <div class="form-inline pull-right">
                    <label class="invisible text-muted" id="search_summary">
                        <span id="search_number">0</span>
                        Found
                    </label>
                    <form method="post" t-att-action="keep('/event/' + slug(event) + '/agenda')">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <div class="pull-right">
                            <input type="text" class="form-control" placeholder="Filter Tracks..." id="event_track_search"/>
                            <br />
                            <a id="tags-clear-button" t-attf-href="/event/#{slug(event)}/agenda" class="btn btn-default text-danger">
                                <span class="fa fa-trash" />Clear tags
                            </a>
                        </div>

                        <div id="filter-track-tags" class="mt16">
                            <t t-foreach="event.allowed_track_tag_ids" t-as="tag">
                                <button type="submit"
                                       t-att-class="'btn btn-primary' if str(tag.id) in search_tags_list else 'btn btn-default'"
                                       t-attf-value="#{tag.name}"
                                       t-attf-name="tag_#{tag.id}">
                                    <span class="fa fa-tags" />
                                    <t t-esc="tag.name" /> (<t t-esc="tag.track_count" />)
                                </button>
                            </t>
                        </div>
                    </form>
                </div>
            </section>
            <t t-set="dayslist" t-value="days.keys()"/>
            <t t-set="dayslist2" t-value="dayslist.sort()"/> <!-- display days in the right order -->

            <section class="container mt16" t-foreach="dayslist" t-as="day">
                <t t-set="locations" t-value="days[day]['locations']"/>
                <t t-set="dates" t-value="days[day]['dates']"/>
                <h3 class="page-header mt0">
                    <t t-esc="day"/>
                    <small>
                        <t t-esc="days_nbr[day]"/>
                        talks
                    </small>
                </h3>
                <table id="table_search" class="table table-bordered table-condensed">
                    <tr class="agenda-locations-row">
                        <th/>
                        <t t-foreach="locations.keys()" t-as="location">
                            <th t-if="location" class="active">
                                <span t-esc="location and location.name or 'Unknown'"/>
                            </th>
                        </t>
                    </tr>
                    <tr t-foreach="dates" t-as="dt" class="agenda-timeslot-row">
                        <td class="active agenda-timeslot-time">
                            <span t-esc="dt[0].strftime('%H:%M')"/> - <span t-esc="dt[3].strftime('%H:%M')"/>
                        </td>
                        <t t-if="dt[2]"> <!-- Not a multi location -->
                            <t t-foreach="locations" t-as="location">
                                <t t-if="location and dt[1].get(location, False)">
                                    <t t-set="track" t-value="dt[1][location][0]"/>
                                    <t t-if="track">
                                        <td t-att-rowspan="dt[1][location][3]"
                                            t-attf-class="event_color_#{track.color} #{track and 'event_track' or ''}">
                                            <t t-if="track">
                                                <t t-call="website_event_track_advanced.agenda-track-td-content" />
                                            </t>
                                        </td>
                                    </t>
                                    <td t-if="not track" t-att-rowspan="dt[1][location][3]" class="event_track"/>
                                </t>
                            </t>
                        </t>
                        <t t-if="not dt[2]">
                            <t t-set="track" t-value="dt[1][False][0]"/>
                            <td t-att-colspan="len(locations)-1"
                                t-attf-class="text-center event_color_#{track.color} #{track and 'event_track' or ''}">
                                <t t-call="website_event_track_advanced.agenda-track-td-content" />
                            </td>
                        </t>
                    </tr>
                </table>
            </section>
        </t>

        <script type="text/javascript" src="/website_event_track_advanced/static/src/js/agenda.js"></script>
    </template>

    <!--Agenda td content -->
    <template id="agenda-track-td-content">
        <a t-attf-href="/event/#{ slug(event) }/track/#{ slug(track) }">
            <div style="height:100%;width:100%">
                <div class="track-td-name">
                    <span t-esc="track and track.name"/>
                </div>

                <div class="track-td-speakers mt8">
                    <i t-if="speakers[track.id]" class="fa fa-comment"/>
                    <span t-esc="speakers[track.id]"/>
                </div>

                <div class="track-td-tags mt8">
                    <i t-if="tags[track.id]" class="fa fa-tag"/>
                    <span t-esc="tags[track.id]"/>
                </div>
            </div>
        </a>
    </template>

</odoo>
